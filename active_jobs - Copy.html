<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Active Jobs - Purple Auto Spa</title>
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Tabs for Active vs History */
        .tab-nav {
            display: flex; background: white; padding: 10px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 10px; font-weight: 600; color: #777;
            border-bottom: 3px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .tab-btn.active { color: #6A1B9A; border-color: #6A1B9A; }

        /* Payment Modal Specific */
        .pay-modal-content { text-align: left; }
        .pay-option {
            padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between; cursor: pointer;
        }
        .pay-option.selected { border-color: #6A1B9A; background: #F3E5F5; color: #6A1B9A; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center;">
            
            <span style="font-size:18px; font-weight:600;">Job Manager</span>
        </div>
        <i class="fas fa-sync-alt" onclick="fetchJobs()" style="cursor:pointer; color:#6A1B9A;"></i>
    </div>

    <div class="tab-nav">
        <div class="tab-btn active" onclick="switchTab('active')">Active Jobs</div>
        <div class="tab-btn" onclick="switchTab('history')">History</div>
    </div>

    <div class="dashboard-container" style="padding-top:0;">

        <div id="jobListContainer">
            <div style="text-align:center; padding:40px; color:#999;">Loading Jobs...</div>
        </div>

        <div class="pagination" id="paginationControls">
            <div class="page-btn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></div>
            <span id="pageIndicator" style="display:flex; align-items:center; font-weight:600; font-size:14px; color:#555;">Page 1</span>
            <div class="page-btn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></div>
        </div>

    </div>

    <div class="modal-overlay" id="paymentModal">
        <div class="custom-box pay-modal-content">
            <h3 class="box-title">Deliver Vehicle</h3>
            <p class="box-desc">Select payment mode to close this job.</p>
            
            <div class="pay-option" onclick="selectPayMode('Cash', this)">
                <span><i class="fas fa-money-bill-wave"></i> Cash</span>
                <i class="far fa-circle check-icon"></i>
            </div>
            <div class="pay-option" onclick="selectPayMode('Online', this)">
                <span><i class="fas fa-qrcode"></i> Online / UPI</span>
                <i class="far fa-circle check-icon"></i>
            </div>
            <div class="pay-option" onclick="selectPayMode('Credit', this)">
                <span><i class="fas fa-book"></i> Credit (Udhar)</span>
                <i class="far fa-circle check-icon"></i>
            </div>

            <div class="box-actions" style="margin-top:20px;">
                <button class="box-btn btn-cancel" onclick="closePayModal()">Cancel</button>
                <button class="box-btn btn-confirm" onclick="confirmDelivery()">Deliver</button>
            </div>
        </div>
    </div>

        <script src="assets/js/config.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
        checkAuth();

        // STATE MANAGEMENT
        let currentTab = 'active'; 
        let allJobs = { active: [], history: [] };
        let currentPage = 1;
        const itemsPerPage = 3;
        
        // Delivery Temp Data
        let selectedJobRow = null;
        let selectedPayMode = null;

        window.onload = fetchJobs;

        async function fetchJobs() {
            const container = document.getElementById('jobListContainer');
            const response = await apiRequest('getJobs');
            
            if(response.status === 'success') {
                allJobs.active = response.active;
                allJobs.history = response.history; 
                renderJobs();
            } else {
                container.innerHTML = '<div style="text-align:center; color:red;">Failed to load jobs</div>';
            }
        }

        function renderJobs() {
            const container = document.getElementById('jobListContainer');
            const data = currentTab === 'active' ? allJobs.active : allJobs.history;
            
            if(data.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;"><i class="fas fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i><br>No ${currentTab} jobs found.</div>`;
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(data.length / itemsPerPage);
            if(currentPage > totalPages) currentPage = 1;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = data.slice(start, end);

            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages}`;

            container.innerHTML = '';
            pageData.forEach(job => {
                // Ensure Invoice No is handled as string
                const safeInvId = String(job.InvoiceNo);
                
                let svcs = "Services";
                try { 
                    const list = typeof job.ServiceList === 'string' ? JSON.parse(job.ServiceList) : job.ServiceList;
                    svcs = list.map(s => s.name).join(", ");
                } catch(e) {}

                let actionBtnHtml = '';
                if(currentTab === 'active') {
                    if(job.Status === 'Pending') {
                        actionBtnHtml = `<button class="action-btn btn-start" onclick="updateStatus(${job.row}, 'Washing')"><i class="fas fa-play"></i> Start Wash</button>`;
                    } else if (job.Status === 'Washing') {
                        actionBtnHtml = `<button class="action-btn btn-finish" onclick="updateStatus(${job.row}, 'Completed')"><i class="fas fa-check"></i> Finish Wash</button>`;
                    } else if (job.Status === 'Completed') {
                        actionBtnHtml = `<button class="action-btn btn-deliver" onclick="openPayModal(${job.row})"><i class="fas fa-key"></i> Deliver Vehicle</button>`;
                    }
                } else {
                    if(job.PaymentStatus === 'Unpaid' || job.PaymentMode === 'Credit') {
                        actionBtnHtml = `<button class="action-btn btn-collect" onclick="openPayModal(${job.row}, true)"><i class="fas fa-hand-holding-usd"></i> Collect Payment</button>`;
                    } else {
                        actionBtnHtml = `<div style="text-align:center; font-size:12px; color:#27ae60; font-weight:bold;"><i class="fas fa-check-circle"></i> Paid & Delivered</div>`;
                    }
                }

                container.innerHTML += `
                    <div class="job-card">
                        <div class="menu-wrapper">
                            <button class="menu-btn" onclick="toggleMenu(this)"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="menu-dropdown">
                                <button class="menu-item" onclick="viewInvoice('${safeInvId}')"><i class="fas fa-file-invoice"></i> Invoice</button>
                                <button class="menu-item" onclick="sendWhatsApp('${job.Mobile}', '${job.ClientName}', '${job.Status}', '${job.VehicleName}')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                                <button class="menu-item" onclick="window.location.href='tel:${job.Mobile}'"><i class="fas fa-phone"></i> Call</button>
                                ${currentTab === 'active' ? `<button class="menu-item danger" onclick="deleteJob(${job.row})"><i class="fas fa-trash"></i> Delete</button>` : ''}
                            </div>
                        </div>

                        <div class="job-header">
                            <span class="job-veh">${job.VehicleName} <small style="font-weight:400; color:#777;">(${job.VehicleNo})</small></span>
                            <span class="job-status st-${job.Status}">${job.Status}</span>
                        </div>
                        <div style="font-size:13px; color:#555; margin-bottom:5px;">
                            <i class="fas fa-user"></i> ${job.ClientName}
                        </div>
                        <div style="font-size:12px; color:#777;">${svcs}</div>
                        <div class="job-actions">${actionBtnHtml}</div>
                    </div>
                `;
            });
        }

        // --- IMPORTANT FIX: Invoice Link Generator ---
        function viewInvoice(invId) {
            // # symbol URL ko tod deta hai, isliye encodeURIComponent use karna zaroori hai
            // Example: #1001 ban jayega %231001
            console.log("Opening Invoice:", invId);
            window.location.href = `invoice_view.html?id=${encodeURIComponent(invId)}`;
        }

        function changePage(dir) {
            const data = currentTab === 'active' ? allJobs.active : allJobs.history;
            const totalPages = Math.ceil(data.length / itemsPerPage);
            if(dir === 1 && currentPage < totalPages) currentPage++;
            if(dir === -1 && currentPage > 1) currentPage--;
            renderJobs();
        }

        function switchTab(tab) {
            currentTab = tab; currentPage = 1;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            renderJobs();
        }

        async function updateStatus(rowId, newStatus, payStatus = 'Unpaid', payMode = '') {
            showToast("Updating...", "info");
            const payload = { row: rowId, status: newStatus, paymentStatus: payStatus, paymentMode: payMode };
            const response = await apiRequest('updateJobStatus', payload);
            if(response.status === 'success') { showToast("Updated", "success"); fetchJobs(); }
            else { showToast("Update Failed", "error"); }
        }

        async function deleteJob(rowId) {
            if(await showConfirm("Delete?", "Sure?", "danger")) {
                const res = await apiRequest('deleteJob', { row: rowId });
                if(res.status === 'success') { showToast("Deleted", "success"); fetchJobs(); }
            }
        }

        function openPayModal(row, isCollection = false) {
            selectedJobRow = row; selectedPayMode = null;
            document.querySelectorAll('.pay-option').forEach(el => { el.classList.remove('selected'); el.querySelector('.check-icon').className = 'far fa-circle check-icon'; });
            document.getElementById('paymentModal').classList.add('show');
            document.querySelector('.modal-overlay').style.display = 'flex';
            if(isCollection) { document.querySelector('.box-title').innerText = "Collect Payment"; }
            else { document.querySelector('.box-title').innerText = "Deliver Vehicle"; }
        }
        function closePayModal() {
            document.getElementById('paymentModal').classList.remove('show');
            setTimeout(() => document.querySelector('.modal-overlay').style.display = 'none', 300);
        }
        function selectPayMode(mode, el) {
            selectedPayMode = mode;
            document.querySelectorAll('.pay-option').forEach(opt => { opt.classList.remove('selected'); opt.querySelector('.check-icon').className = 'far fa-circle check-icon'; });
            el.classList.add('selected'); el.querySelector('.check-icon').className = 'fas fa-check-circle check-icon';
        }
        function confirmDelivery() {
            if(!selectedPayMode) { showToast("Select Payment Mode", "error"); return; }
            closePayModal();
            const pStatus = selectedPayMode === 'Credit' ? 'Unpaid' : 'Paid';
            updateStatus(selectedJobRow, 'Delivered', pStatus, selectedPayMode);
        }

                // --- NEW MENU LOGIC (Click Outside to Close) ---
        function toggleMenu(btn) {
            // Event bubbling rokne ke liye
            event.stopPropagation(); 
            
            const dropdown = btn.nextElementSibling;
            const isAlreadyOpen = dropdown.classList.contains('show');

            // Pehle sab band karo (Taaki ek baar me ek hi khule)
            document.querySelectorAll('.menu-dropdown').forEach(d => d.classList.remove('show'));

            // Agar pehle se khula nahi tha, to ab kholo
            if (!isAlreadyOpen) {
                dropdown.classList.add('show');
            }
        }

        // Pure Screen par click detect karo
        window.onclick = function(event) {
            // Agar click Menu Button ya Dropdown ke andar NAHI hai
            if (!event.target.matches('.menu-btn') && !event.target.closest('.menu-dropdown')) {
                document.querySelectorAll('.menu-dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        }

        function sendWhatsApp(mobile, name, status, veh) {
            let msg = `Hello ${name}, status of ${veh}: ${status}. Team Purple.`;
            window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>

</body>
</html>

