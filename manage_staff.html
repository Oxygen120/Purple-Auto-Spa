<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manage Staff - Purple Auto Spa</title>
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Add Staff Form Transition */
        #addStaffForm { display: none; margin-bottom: 20px; animation: slideUp 0.3s; }

        /* Staff Card Extras */
        .balance-pos { color: var(--success); font-weight: bold; }
        .balance-neg { color: var(--danger); font-weight: bold; }
        
        /* NEW: Status Bar inside Card */
        .staff-status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px;
            border: 1px solid #eee;
        }
        .st-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .st-absent { color: #c0392b; background: #fadbd8; }
        .st-present { color: #27ae60; background: #e8f5e9; }
        .st-pending { color: #e67e22; background: #fdebd0; }
        
        .approve-btn {
            background: #27ae60; color: white; border: none; 
            padding: 6px 12px; border-radius: 20px; font-size: 11px; cursor: pointer;
            display: flex; align-items: center; gap: 5px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .staff-actions {
            display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;
        }
        .sa-btn {
            flex: 1; padding: 8px; border: 1px solid #eee; background: white;
            border-radius: 8px; font-size: 12px; cursor: pointer; color: #555;
        }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center;">
            <span style="font-size:18px; font-weight:600;">Manage Staff</span>
        </div>
        <button onclick="toggleAddForm()" style="background:none; border:none; color:var(--primary); font-weight:600;">
            <i class="fas fa-user-plus"></i> Add
        </button>
    </div>

    <div class="dashboard-container">

        <div id="addStaffForm" class="form-card">
            <h3 style="margin-bottom:15px; font-size:16px;">Onboard New Staff</h3>
            <div class="form-group">
                <input type="text" id="newName" class="form-control" placeholder="Full Name">
            </div>
            <div class="form-group">
                <input type="number" id="newMobile" class="form-control" placeholder="Mobile (Login ID)">
            </div>
            <div class="form-group">
                <input type="text" id="newPass" class="form-control" placeholder="Password">
            </div>
            <div class="form-group">
                <input type="number" id="newSalary" class="form-control" placeholder="Monthly Salary (₹)">
            </div>
            <button class="btn-main" onclick="addNewStaff()">Save Staff</button>
        </div>

        <div id="staffList">
            <div style="text-align:center; padding:30px; color:#999;">Loading Staff...</div>
        </div>

    </div>

    <div class="modal-overlay" id="salaryModal">
        <div class="custom-box" style="text-align:left;">
            <h3 class="box-title">Pay Staff</h3>
            <p class="box-desc" id="payModalName">Record Salary or Advance payment</p>
            
            <div class="form-group">
                <label class="form-label">Amount (₹)</label>
                <input type="number" id="payAmount" class="form-control" placeholder="Enter Amount">
            </div>
            
            <div class="box-actions">
                <button class="box-btn btn-cancel" onclick="closePayModal()">Cancel</button>
                <button class="box-btn btn-confirm" onclick="confirmPayment()">Pay & Record</button>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
        checkAuth();
        
        // --- GLOBAL VARIABLES (Fixed) ---
        let currentPayStaffId = null; // Store ID for backend
        let currentPayName = "";

        window.onload = function() {
            loadData();
        };

        async function loadData() {
            const [staffRes, attRes] = await Promise.all([
                apiRequest('getAllStaff'),
                apiRequest('getStaffAttendance')
            ]);

            const todayData = attRes.todayData || {};
            renderStaffList(staffRes.staff || [], todayData);
        }

        // --- RENDER STAFF WITH STATUS ---
        function renderStaffList(list, todayMap) {
            const container = document.getElementById('staffList');
            container.innerHTML = '';

            list.forEach(st => {
                if(st.role === 'Admin') return; 

                const isInactive = st.status === 'Inactive';
                const balanceClass = st.balance >= 0 ? 'balance-pos' : 'balance-neg';
                
                const att = todayMap[st.id];
                let statusHtml = '';

                if (!att) {
                    statusHtml = `<span class="st-badge st-absent">Absent</span>`;
                } else if (att.status === 'Pending') {
                    // Map Link fixed
                    const mapUrl = `https://www.google.com/maps?q=${att.location}`;
                    statusHtml = `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span class="st-badge st-pending">Pending</span>
                            <a href="${mapUrl}" target="_blank" style="color:#1565c0; font-size:14px;"><i class="fas fa-map-marker-alt"></i></a>
                            <button class="approve-btn" onclick="approveEntry(${att.row})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>`;
                } else if (att.status === 'Present') {
                    statusHtml = `<span class="st-badge st-present"><i class="fas fa-check-circle"></i> Present</span>`;
                }
                
                container.innerHTML += `
                    <div class="job-card" style="border-left:none; opacity: ${isInactive ? 0.7 : 1}">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <h3 style="font-size:16px; margin:0;">${st.name}</h3>
                                <div style="font-size:12px; color:#777; margin-top:2px;">
                                    <a href="tel:${st.mobile}"><i class="fas fa-phone"></i> ${st.mobile}</a>
                                </div>
                                <div style="font-size:11px; color:#555; margin-top:5px;">
                                    Salary: ₹${st.salary} | Balance: <span class="${balanceClass}">₹${st.balance}</span>
                                </div>
                            </div>
                            
                            <div style="text-align:right;">
                                <label class="switch" style="transform:scale(0.8);">
                                    <input type="checkbox" ${isInactive ? '' : 'checked'} onchange="toggleStaff(${st.row}, this)">
                                    <span class="slider"></span>
                                </label>
                                <div style="font-size:10px; margin-top:5px; color:${isInactive ? 'red':'green'}">
                                    ${isInactive ? 'Inactive' : 'Active'}
                                </div>
                            </div>
                        </div>

                        <div class="staff-status-bar">
                            <div style="font-size:12px; font-weight:600; color:#555;">Today:</div>
                            ${statusHtml}
                        </div>

                        <div class="staff-actions">
                            <button class="sa-btn" onclick="openPayModal('${st.id}', '${st.name}')"><i class="fas fa-hand-holding-usd"></i> Pay</button>
                            <button class="sa-btn" onclick="viewHistory('${st.id}', '${st.name}')"><i class="fas fa-calendar-alt"></i> History</button>
                        </div>
                    </div>
                `;
            });
        }

        async function approveEntry(rowId) {
            const res = await apiRequest('approveAttendance', { row: rowId });
            if(res.status === 'success') {
                showToast("Attendance Approved", "success");
                loadData();
            } else {
                showToast("Failed to approve", "error");
            }
        }

        function toggleAddForm() {
            const form = document.getElementById('addStaffForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        async function addNewStaff() {
            const name = document.getElementById('newName').value;
            const mobile = document.getElementById('newMobile').value;
            const pass = document.getElementById('newPass').value;
            const salary = document.getElementById('newSalary').value;

            if(!name || !mobile || !pass) {
                showToast("Please fill all details", "error");
                return;
            }

            const btn = document.querySelector('#addStaffForm button');
            btn.innerHTML = 'Saving...'; btn.disabled = true;

            const res = await apiRequest('addStaff', { name, mobile, password: pass, salary });
            
            if(res.status === 'success') {
                showToast("Staff Added!", "success");
                document.getElementById('addStaffForm').style.display = 'none';
                loadData();
                document.getElementById('newName').value = '';
                document.getElementById('newMobile').value = '';
            } else {
                showToast("Failed to add staff", "error");
            }
            btn.innerHTML = 'Save Staff'; btn.disabled = false;
        }

        async function toggleStaff(rowId, checkbox) {
            const newStatus = checkbox.checked ? 'Active' : 'Inactive';
            await apiRequest('toggleStaffStatus', { row: rowId, status: newStatus });
            showToast(`Staff marked ${newStatus}`, "info");
            loadData();
        }

        function viewHistory(id, name) {
            window.location.href = `myspace.html?staffId=${id}&viewName=${encodeURIComponent(name)}`;
        }

        // --- UPDATED PAYMENT LOGIC ---
        function openPayModal(id, name) { // Accept ID
            currentPayStaffId = id; // Save ID
            currentPayName = name;
            document.getElementById('payModalName').innerText = `Paying to: ${name}`;
            document.getElementById('payAmount').value = '';
            document.getElementById('salaryModal').classList.add('show');
            document.querySelector('.modal-overlay').style.display = 'flex';
        }

        function closePayModal() {
            document.getElementById('salaryModal').classList.remove('show');
            setTimeout(() => document.querySelector('.modal-overlay').style.display = 'none', 300);
        }

        async function confirmPayment() {
            const amt = document.getElementById('payAmount').value;
            if(!amt) return;
            
            const btn = document.querySelector('.btn-confirm');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";

            // Send ID and Name to backend
            const res = await apiRequest('paySalary', { 
                staffId: currentPayStaffId, 
                staffName: currentPayName, 
                amount: amt 
            });

            if(res.status === 'success') {
                showToast("Payment Recorded", "success");
                closePayModal();
                loadData();
            } else {
                showToast("Error recording payment", "error");
            }
            btn.innerText = originalText;
        }

    </script>
</body>
</html>

